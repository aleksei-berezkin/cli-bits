#!/usr/bin/env node

/*
 * Outputs TypeScript-Go WebStorm-format logs in a readable way.
 *
 * Usage:
 *
 * cd webstorm-logs-20260114-130539/language-services
 * tsLog TypeScript-Go-20260114-130448-667.log | less
 */

import fs from 'node:fs'

const fileName = process.argv[2]
if (!fileName) throw new Error('File not specified')

for (const line of String(fs.readFileSync(fileName)).split('\n')) {
  if (!line)
    continue

  // 2026-01-14 13:05:27.956 IN
  const m = /^\d\d\d\d-\d\d-\d\d \d\d:\d\d:\d\d\.\d\d\d (\w+)\s+/.exec(line)
  if (!m) {
    console.log(line)
    continue
  }
  const [prefix] = m

  const jsonRawStr = line.slice(m[0].length)
  const jsonObj = parseJsonSafe(jsonRawStr)
  if (!jsonObj) {
    console.log(line)
    continue
  }

  const jsonFmtStr = JSON.stringify(jsonObj, null, 2)
  for (const jsonLine of jsonFmtStr.split('\n')) {
    const [contentFirstLine, ...contentLinesTail] = jsonLine.split('\\n')
    console.log(`${prefix}${contentFirstLine}`)

    const contentIndent = /^\s*/.exec(contentFirstLine)
    for (const contentLine of contentLinesTail) {
      console.log(`${prefix}${contentIndent}  ${contentLine.replaceAll('\\t', '  ')}`)
    }
  }

  console.log()
}

function parseJsonSafe(str) {
  try {
    return JSON.parse(str)
  } catch (e) {
  }
}
